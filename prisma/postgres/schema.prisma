// Prisma schema for MCP Bundler (SQLite variant)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgres"
  url      = env("DATABASE_URL")
}

// Auth strategy for MCPs in bundles
enum AuthStrategy {
  MASTER         // Use master token from Mcp.masterAuth
  USER_SET       // Use token-specific credentials from BundledMCPCredential
  NONE           // No authentication required
}

// Bundle - Groups of MCPs with a certain purpose
model Bundle {
  id          String   @id @default(uuid())
  name        String
  description String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by_id")

  // Relations
  createdBy      ApiUser?         @relation("BundleCreator", fields: [createdById], references: [id], onDelete: SetNull)
  mcps           MCPBundleEntry[]
  tokens         BundleAccessToken[]

  @@unique([name, createdById])
  @@index([createdById])
  @@map("bundles")
}

// MCPs - Master MCP definitions
model Mcp {
  id               String   @id @default(uuid())
  namespace        String   @unique
  url              String
  description      String
  version          String   @default("1.0.0")
  stateless        Boolean  @default(false)
  authStrategy AuthStrategy @default(NONE) @map("auth_strategy")
  masterAuth       String?  @map("master_auth_config") // Optional shared credentials (JSON string)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  createdById      String?  @map("created_by_id")

  // Relations
  createdBy        ApiUser?                     @relation("McpCreator", fields: [createdById], references: [id], onDelete: SetNull)
  mcps             MCPBundleEntry[]
  bundledMcpToken  BundledMCPCredential[]

  @@index([createdById])
  @@map("mcps")
}

// Bundle MCPs - Junction table with per-MCP permissions and auth strategy
model MCPBundleEntry {
  id           String       @id @default(uuid())
  bundleId     String       @map("bundle_id")
  mcpId        String       @map("mcp_id")
  bundle       Bundle       @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  mcp          Mcp          @relation(fields: [mcpId], references: [id], onDelete: Cascade)
  addedAt      DateTime     @default(now()) @map("added_at")

  // Per-MCP permissions (shared by all tokens, stored as JSON strings)
  // Use ["*"] for ALL, [] for NONE, or specific tool/resource/prompt names
  allowedTools     String @default("[\"*\"]") @map("allowed_tools")
  allowedResources String @default("[\"*\"]") @map("allowed_resources")
  allowedPrompts   String @default("[\"*\"]") @map("allowed_prompts")

  @@unique([bundleId, mcpId])
  @@map("mcp_bundle_entry")
}

// Bundle access tokens
model BundleAccessToken {
  id           String     @id @default(uuid())
  bundleId     String     @map("bundle_id")
  bundle       Bundle     @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  name         String
  description  String?
  tokenHash    String     @unique @map("token_hash") // SHA-256 hash
  expiresAt    DateTime?  @map("expires_at")
  revoked      Boolean    @default(false)
  createdAt    DateTime   @default(now()) @map("created_at")
  lastUsedAt   DateTime?  @map("last_used_at")
  createdById  String     @map("created_by_id")
  createdBy    ApiUser    @relation("BundleTokenCreator", fields: [createdById], references: [id], onDelete: Cascade)

  // Relations
  mcpTokens   BundledMCPCredential[]

  @@map("bundle_access_tokens")
}

// Token-specific MCP credentials (used when authStrategy = USER_SET)
model BundledMCPCredential {
  id           String   @id @default(uuid())
  tokenId      String   @map("token_id")
  mcpId        String   @map("mcp_id")
  authConfig   String   @map("auth_config") // Encrypted JSON string
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  owner        BundleAccessToken    @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  mcp          Mcp                  @relation(fields: [mcpId], references: [id], onDelete: Cascade)

  @@unique([tokenId, mcpId])
  @@map("bundle_token_mcp_credential")
}

// API keys for management API authentication
model ApiUser {
  id          String      @id @default(uuid())
  name        String      // Descriptive name (e.g., "Production Server", "CI/CD Pipeline")
  department  String?     @map("department")
  contact     String      @map("contact") // for example email
  keyHash     String      @unique @map("key_hash")
  createdAt   DateTime    @default(now()) @map("created_at")
  lastUsedAt  DateTime?   @map("last_used_at")
  revokedAt   DateTime?   @map("revoked_at")
  isAdmin     Boolean     @map("is_admin")

  createdById String?     @map("created_by_id")
  createdBy   ApiUser?    @relation("CreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdUsers       ApiUser[]            @relation("CreatedBy")
  permissions        ApiUserPermission[]
  createdBundles     Bundle[]             @relation("BundleCreator")
  createdMcps        Mcp[]                @relation("McpCreator")
  createdTokens      BundleAccessToken[]  @relation("BundleTokenCreator")

  @@index([isAdmin])
  @@index([revokedAt])
  @@index([createdById])
  @@index([lastUsedAt])
  @@map("api_user")
}

enum PermissionType {
  CREATE_USER
  ADD_MCP
  LIST_USERS
  VIEW_PERMISSIONS
}

model ApiUserPermission {
  id                        String   @id @default(uuid())
  userId                    String   @map("user_id")
  user       ApiUser        @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission PermissionType @map("permission_type")

  @@unique([userId, permission])
  @@index([permission])
  @@map("api_user_permission")
}

// Global settings for self-service registration and other system-wide configs
model GlobalSettings {
  id                             String   @id @default("global")
  allowSelfServiceRegistration   Boolean  @default(false) @map("allow_self_service_registration")
  defaultSelfServicePermissions  String   @default("[]") @map("default_self_service_permissions") // JSON array of PermissionType

  @@map("global_settings")
}
